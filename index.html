<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebARãƒ‡ãƒ¢ï¼ˆiOS Quick Look / Android Scene Viewer / Desktopãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</title>
  <!-- èª¬æ˜:
    - iOS: Quick Look (USDZ)
    - Android: Scene Viewer (GLB/GLTF)
    - Desktop: 3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + QRã‚³ãƒ¼ãƒ‰ã§ã‚¹ãƒãƒ›ã¸
    - å¯èƒ½ãªã‚‰ <model-viewer> ã«ã‚ˆã‚‹3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ARèµ·å‹•
  -->

  <!-- 3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼ˆGoogle model-viewerï¼‰
       å…¬å¼: https://modelviewer.dev/  -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>

  <!-- Desktopâ†’ã‚¹ãƒãƒ›é·ç§»ç”¨ã®QRã‚³ãƒ¼ãƒ‰ï¼ˆè»½é‡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- äº‹å‰èª­ã¿è¾¼ã¿ï¼ˆä»»æ„ï¼‰ -->
  <!-- äº‹å‰èª­ã¿è¾¼ã¿ï¼ˆä»»æ„ï¼‰: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å…¬é–‹ãƒ‡ãƒ¢ãƒ¢ãƒ‡ãƒ«ã‚’preload -->
  <link rel="preload" href="./model.usdz" as="fetch" crossorigin>
  <link rel="preload" href="https://modelviewer.dev/shared-assets/models/Astronaut.glb" as="fetch" crossorigin>

  <style>
    :root {
      --bg: #0b0f1a;
      --card: #111827;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, #0f172a 0%, var(--bg) 60%);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }
    .wrap { width: 100%; max-width: 980px; }
    header { text-align: center; margin-bottom: 16px; }
    h1 { font-size: clamp(22px, 4vw, 32px); margin: 0 0 8px; }
    p.lead { color: var(--muted); margin: 0; }

    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 960px) {
      .grid { grid-template-columns: 2fr 1fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow: hidden;
    }

    model-viewer {
      width: 100%;
      height: 56vh;
      min-height: 360px;
      background: #0a0e1a;
    }

    .panel { padding: 16px; }
    .buttons { display: flex; flex-wrap: wrap; gap: 12px; }
    .button, a.button {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; text-decoration: none;
      padding: 12px 16px; border-radius: 12px; font-weight: 600;
      background: var(--accent); color: white; border: none; cursor: pointer;
      transition: transform .06s ease, filter .15s ease;
    }
    .button.secondary { background: #334155; }
    .button.ghost { background: transparent; border: 1px solid #334155; }
    .button:hover { filter: brightness(1.08); }
    .button:active { transform: translateY(1px); }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }

    .qr-wrap { display: none; align-items: center; gap: 12px; }
    .qr-box {
      width: 140px; height: 140px; padding: 8px; border-radius: 12px;
      background: white; display: grid; place-items: center;
    }

    footer { margin-top: 18px; text-align: center; color: var(--muted); font-size: 12px; }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; }
      /* ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆå††ã‚°ãƒªãƒƒãƒ‰é¢¨ï¼‰ */
    #reticle {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08) inset, 0 0 30px rgba(0,0,0,0.35);
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.25) 0 2px, transparent 2px 100%),
        repeating-conic-gradient(from 0deg, rgba(255,255,255,0.08) 0 10deg, transparent 10deg 20deg);
      display: none;
      pointer-events: none;
      transform: translate(-50%, -50%);
      position: absolute; top: 50%; left: 50%;
    }
    model-viewer[ar-status="session-started"] #reticle { display: block; }
      /* ã‚µãƒ ãƒã‚¤ãƒ«&ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .thumbs { display: flex; flex-wrap: wrap; gap: 10px; }
    .thumb { width: 88px; height: 88px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); background: #0b1220; cursor: pointer; display:grid; place-items:center; }
    .thumb img { max-width: 100%; max-height: 100%; opacity: .9; }
    .thumb.active { outline: 2px solid var(--accent); }
    .controls { display: grid; gap: 8px; }
    .controls label { display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 14px; color: var(--muted); }
    .controls input[type="range"] { width: 180px; }
    .controls .row { gap: 6px; }

    /* ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ */
    .confetti { position: fixed; top: -10px; width: 8px; height: 14px; opacity: 0.9; transform: rotate(0deg); will-change: transform, top, opacity; }
    .confetti.anim { animation: fall 900ms ease-out forwards; }
    @keyframes fall { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(110vh) rotate(540deg); opacity: 0; } }

      /* ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆå††ã‚°ãƒªãƒƒãƒ‰é¢¨ï¼‰ */
    #reticle {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08) inset, 0 0 30px rgba(0,0,0,0.35);
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.25) 0 2px, transparent 2px 100%),
        repeating-conic-gradient(from 0deg, rgba(255,255,255,0.08) 0 10deg, transparent 10deg 20deg);
      display: none;
      pointer-events: none;
      transform: translate(-50%, -50%);
      position: absolute; top: 50%; left: 50%;
    }
    model-viewer[ar-status="session-started"] #reticle { display: block; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARã§è¦‹ã‚‹</h1>
      <p class="lead">iOS / Android / Desktop ã©ã‚Œã§ã‚‚OKã€‚ã¾ãšã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ç«¯æœ«ã«å¿œã˜ã¦æœ€é©ãªARã‚’èµ·å‹•ã—ã¾ã™ã€‚</p>
    </header>

    <div class="grid">
      <!-- å·¦: 3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div class="card">
        <!--
          src: Android/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼ˆglb/gltfï¼‰
          ios-src: iOS Quick Lookç”¨ï¼ˆusdzï¼‰
          ar-modes: å¯èƒ½ãªARèµ·å‹•æ‰‹æ®µã‚’åˆ—æŒ™
        -->
        <model-viewer id="viewer"$1environment-image="https://modelviewer.dev/shared-assets/environments/spruit_sunrise_1k_HDR.hdr" alt="3Dãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">

          <!-- model-viewer å†…ã®ARãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ -->
          <button slot="ar-button" class="button">ğŸ“± ARã§è¡¨ç¤º</button>
          <div class="hint" slot="poster">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

          <!-- ç½®ãå ´æ‰€ã®ç°¡æ˜“ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆWebXRæ™‚ã«è¡¨ç¤ºï¼‰ -->
          <div id="reticle" slot="ar" aria-hidden="true"></div>
        </model-viewer>
      </div>

      <!-- å³: æ“ä½œãƒ‘ãƒãƒ« -->
      <div class="card panel">
        <h2 style="margin-top:0">ç«¯æœ«ã«åˆã‚ã›ã¦ARèµ·å‹•</h2>
        <div class="buttons" style="margin-bottom:8px">
          <!-- iOS Quick Look: a[rel=ar] ãŒæœ€çŸ­ -->
          <a id="btn-ios" class="button" rel="ar" href="#" title="iPhone / iPad ç”¨">
            ï£¿ iPhone / iPad ã§AR
          </a>

          <!-- Android Scene Viewer: intent URLã‚’ç”Ÿæˆ -->
          <a id="btn-android" class="button secondary" href="#" title="Android ç”¨">
            ğŸ¤– Androidã§AR
          </a>

          <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: QRã‚³ãƒ¼ãƒ‰ or å…±æœ‰ãƒªãƒ³ã‚¯ -->
          <button id="btn-desktop" class="button ghost" title="ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å‘ã‘">
            ğŸ–¥ï¸ ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—â†’ã‚¹ãƒãƒ›
          </button>
        </div>

        <!-- æ¥½ã—ã‚€ï¼šãƒ¢ãƒ‡ãƒ«åˆ‡æ›¿ & è¦‹æ „ãˆèª¿æ•´ -->
        <div style="margin:10px 0 6px; font-weight:700">ãƒ¢ãƒ‡ãƒ«ã‚’é¸ã¶</div>
        <div id="presets" class="thumbs"></div>

        <div style="margin:12px 0 6px; font-weight:700">ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°</div>
        <div class="controls">
          <label>éœ²å‡º <input id="ctrl-exposure" type="range" min="0.2" max="2.0" step="0.05" value="1.0"></label>
          <label>å½±ã®æ¿ƒã• <input id="ctrl-shadow" type="range" min="0" max="2" step="0.05" value="1"></label>
          <label class="row"><input id="ctrl-autorotate" type="checkbox" checked> è‡ªå‹•å›è»¢</label>
        </div>

        <div id="qr" class="qr-wrap">
          <div class="qr-box"><div id="qrcode"></div></div>
          <div>
            <div>ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§QRã‚’èª­ã¿å–ã£ã¦ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚</div>
            <div class="hint">åŒã˜Wiâ€‘Fiã§ãªã„å ´åˆã¯ã€ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°URLãŒå¤–éƒ¨ã‹ã‚‰åˆ°é”å¯èƒ½ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</div>
          </div>
        </div>

        <hr style="border-color: rgba(255,255,255,0.06); margin:16px 0;">
        <details>
          <summary>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¡ãƒ¢</summary>
          <ul style="margin:8px 0 0 16px; color: var(--muted); font-size: 14px;">
            <li><code>./model.usdz</code>ï¼ˆiOSå‘ã‘ï¼‰ã¨<code>./model.glb</code>ï¼ˆAndroid/ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‘ã‘ï¼‰ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã€‚</li>
            <li>Androidã®Scene Viewerã¯HTTPSã‹ã¤å…¬é–‹URLæ¨å¥¨ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã®å ´åˆã¯USBãƒ‡ãƒãƒƒã‚°ã‹ã‚‰é–‹ç™ºè€…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç­‰ã§æ¤œè¨¼ã€‚</li>
            <li>Quick Lookã®æŒ™å‹•ï¼ˆå›ºå®šã‚¹ã‚±ãƒ¼ãƒ«ç­‰ï¼‰ã¯USDZå´ã®è¨­å®šã«ä¾å­˜ã—ã¾ã™ã€‚</li>
          </ul>
        </details>
      </div>
    </div>

    <footer>
      <span>ARèµ·å‹•ãŒã†ã¾ãã„ã‹ãªã„æ™‚ã¯ã€ç«¯æœ«ã®OS/ãƒ–ãƒ©ã‚¦ã‚¶ã®æœ€æ–°ç‰ˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</span>
    </footer>
  </div>

  <script>
    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ç«¯æœ«åˆ¤å®š ---
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(ua);

    // --- è¦ç´ å‚ç…§ ---
    const btnIOS = document.getElementById('btn-ios');
    const btnAndroid = document.getElementById('btn-android');
    const btnDesktop = document.getElementById('btn-desktop');
    const qrWrap = document.getElementById('qr');

    // --- Android Scene Viewer intent URLã‚’æ§‹ç¯‰ ---
    function buildSceneViewerUrl(params) {
      const base = 'https://arvr.google.com/scene-viewer/1.0';
      const url = new URL(base);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      return url.toString();
    }

    // ã“ã“ã¯å…¬é–‹URLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³æ¨å¥¨ï¼‰
    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«å·®ã—æ›¿ãˆå¯èƒ½: ?glb=...&usdz=...
    const params = new URLSearchParams(location.search);
    const defaultGLB = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
    const localUSDZ = new URL('./model.usdz', location.href).toString();
    const fallbackUSDZDemo = 'https://modelviewer.dev/shared-assets/models/Astronaut.usdz';
    const glbUrl = params.get('glb') || defaultGLB;
    // iPhone/iPadã§ã¯ã¾ãšãƒ­ãƒ¼ã‚«ãƒ« model.usdz ã‚’ä½¿ã†ï¼ˆæŒ‡å®šãŒã‚ã‚Œã° ?usdz=... ã‚’å„ªå…ˆï¼‰
    let usdzUrl = params.get('usdz') || localUSDZ;

    // model-viewerã¸åæ˜ 
    const viewer = document.getElementById('viewer');
    viewer.setAttribute('src', glbUrl);
    viewer.setAttribute('ios-src', usdzUrl);

    // Androidãƒœã‚¿ãƒ³ã®hrefã‚’è¨­å®š
    const sceneViewerURL = buildSceneViewerUrl({
      file: glbUrl,
      mode: 'ar_only',
      title: document.title || 'WebAR Model',
      // link ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æˆ»ã‚Šå…ˆï¼ˆä»»æ„ï¼‰
      link: location.href
    });
    btnAndroid.href = sceneViewerURL;
    // iOSãƒœã‚¿ãƒ³ã®hrefã‚‚å‹•çš„ã«åæ˜ 
    btnIOS.href = usdzUrl;

    // --- ç«¯æœ«åˆ¥ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒœã‚¿ãƒ³ã‚’å¼·èª¿è¡¨ç¤º ---
    if (isIOS) {
      btnIOS.classList.remove('secondary', 'ghost');
    } else if (isAndroid) {
      btnAndroid.classList.remove('secondary');
      btnAndroid.classList.add('button');
    } else {
      btnDesktop.classList.remove('ghost');
      btnDesktop.classList.add('button');
    }

    // --- Desktop: QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤º ---
    let qrRendered = false;
    btnDesktop?.addEventListener('click', () => {
      qrWrap.style.display = qrWrap.style.display === 'flex' ? 'none' : 'flex';
      if (!qrRendered) {
        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URLã‚’QRåŒ–
        // å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹URLã§ãƒ›ã‚¹ãƒˆã—ã¦ãã ã•ã„
        new QRCode(document.getElementById('qrcode'), {
          text: location.href,
          width: 120,
          height: 120,
          correctLevel: QRCode.CorrectLevel.M
        });
        qrRendered = true;
      }
    });

    // --- Web Share APIï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰---
    if (navigator.share) {
      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'ğŸ“¤ å…±æœ‰';
      shareBtn.className = 'button ghost';
      shareBtn.style.marginLeft = '8px';
      shareBtn.addEventListener('click', async () => {
        try {
          await navigator.share({ title: document.title, url: location.href });
        } catch (e) { /* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã© */ }
      });
      document.querySelector('.buttons').appendChild(shareBtn);
    }

    // --- ã¡ã‚‡ã„ä¸Šç´š: iOSã§ã®å³æ™‚Quick Lookèµ·å‹•ï¼ˆä»»æ„ï¼‰ ---
    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºã¨åŒæ™‚ã«èµ·å‹•ã—ãŸã„å ´åˆãªã©ã¯ä»¥ä¸‹ã‚’æ´»ç”¨ï¼ˆUXã«æ³¨æ„ï¼‰
    // if (isIOS) {
    //   const a = document.createElement('a');
    //   a.setAttribute('rel', 'ar');
    //   a.setAttribute('href', './model.usdz');
    //   a.style.display = 'none';
    //   document.body.appendChild(a);
    //   a.click();
    //   a.remove();
    // }
      // --- 404å¯¾ç­–: ãƒ¢ãƒ‡ãƒ«URLã®å¦¥å½“æ€§ã‚’è»½é‡ãƒã‚§ãƒƒã‚¯ï¼ˆHEADãŒä½¿ãˆãªã„ç’°å¢ƒã¯GETã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ---
    async function assertReachable(url) {
      try {
        const res = await fetch(url, { method: 'HEAD', mode: 'cors' });
        if (!res.ok) throw new Error(String(res.status));
        return true;
      } catch (e) {
        console.warn('ãƒ¢ãƒ‡ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:', url, e);
        return false;
      }
    }

    (async () => {
      const okGLB = await assertReachable(glbUrl);
      let okUSDZ = await assertReachable(usdzUrl);

      // iOSå„ªå…ˆ: ãƒ­ãƒ¼ã‚«ãƒ«USDZãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ¢ã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (isIOS && !okUSDZ) {
        console.warn('local USDZ not found. Falling back to demo USDZ.');
        usdzUrl = fallbackUSDZDemo;
        viewer.setAttribute('ios-src', usdzUrl);
        btnIOS.href = usdzUrl;
        okUSDZ = await assertReachable(usdzUrl);
      }

      const warn = [];
      if (!okGLB) warn.push('GLB');
      if (!okUSDZ) warn.push('USDZ');
      if (warn.length) {
        const el = document.createElement('div');
        el.role = 'status';
        el.style.cssText = 'margin-top:8px;color:#fca5a5;font-size:12px;';
        el.textContent = `${warn.join(' / ')} ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã¾ãŸã¯ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šï¼ˆMIME typeå«ã‚€ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        document.querySelector('.panel').appendChild(el);
      }
    })();

    // --- WebXRç°¡æ˜“ã€Œã‚¹ãƒãƒƒãƒˆç½®ãã€ + æ¼”å‡º ---
    const reticle = document.getElementById('reticle');

    function haptic() { if (navigator.vibrate) navigator.vibrate(15); }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'triangle'; o.frequency.value = 660; g.gain.value = 0.05;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 120);
      } catch (e) {}
    }

    function spawnConfetti(n=24) {
      for (let i=0;i<n;i++) {
        const el = document.createElement('div');
        el.className = 'confetti anim';
        const hue = Math.floor(Math.random()*360);
        el.style.background = `hsl(${hue} 90% 60%)`;
        el.style.left = (Math.random()*100)+'vw';
        el.style.animationDelay = (Math.random()*0.2)+'s';
        el.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 1000);
      }
    }

    function popReticle() {
      if (!reticle || viewer.getAttribute('ar-status') !== 'session-started') return;
      reticle.animate([
        { transform: 'translate(-50%, -50%) scale(0.6)', opacity: 0.0 },
        { transform: 'translate(-50%, -50%) scale(1.0)', opacity: 1.0, offset: 0.5 },
        { transform: 'translate(-50%, -50%) scale(1.0)', opacity: 0.0 }
      ], { duration: 420, easing: 'ease-out' });
      haptic();
      playBeep();
      spawnConfetti(18);
    }

    viewer.addEventListener('click', () => popReticle());

    // --- ãƒ¢ãƒ‡ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/Androidå‘ã‘GLBã€‚iOSã¯ãƒ­ãƒ¼ã‚«ãƒ«USDZã‚’å„ªå…ˆï¼‰ ---
    const presets = [
      { name:'Astronaut', glb:'https://modelviewer.dev/shared-assets/models/Astronaut.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/Astronaut.webp' },
      { name:'Robot', glb:'https://modelviewer.dev/shared-assets/models/RobotExpressive.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/RobotExpressive.webp' },
      { name:'Horse', glb:'https://modelviewer.dev/shared-assets/models/Horse.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/Horse.webp' }
    ];

    const $presets = document.getElementById('presets');
    const presetEls = presets.map((p, idx) => {
      const b = document.createElement('button');
      b.className = 'thumb'+(idx===0?' active':'');
      b.title = p.name;
      const img = document.createElement('img'); img.src = p.thumb; img.alt = p.name; b.appendChild(img);
      b.addEventListener('click', () => {
        presetEls.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        viewer.setAttribute('src', p.glb);
        // Androidã®Scene Viewerã‚‚æ›´æ–°
        const updated = buildSceneViewerUrl({ file: p.glb, mode:'ar_only', title: document.title || p.name, link: location.href });
        btnAndroid.href = updated;
      });
      $presets.appendChild(b); return b;
    });

    // --- éœ²å‡º/å½±/å›è»¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ---
    const ctrlExposure = document.getElementById('ctrl-exposure');
    const ctrlShadow = document.getElementById('ctrl-shadow');
    const ctrlAuto = document.getElementById('ctrl-autorotate');
    ctrlExposure.addEventListener('input', () => viewer.setAttribute('exposure', ctrlExposure.value));
    ctrlShadow.addEventListener('input', () => viewer.setAttribute('shadow-intensity', ctrlShadow.value));
    ctrlAuto.addEventListener('change', () => ctrlAuto.checked ? viewer.setAttribute('auto-rotate','') : viewer.removeAttribute('auto-rotate'));

    // è£œè¶³: æœ¬å½“ã«å¹³é¢ã«æ²¿ã£ã¦ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«(ãƒ¡ãƒƒã‚·ãƒ¥)ã‚’è¡¨ç¤ºã—ã€ã‚¿ãƒƒãƒ—ã§ç¢ºå®šé…ç½®ã—ãŸã„å ´åˆã¯
    // three.js + WebXR Hit Test API ã§ã®å®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
  </script>
</body>
</html>
