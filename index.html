<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebARデモ（iOS Quick Look / Android Scene Viewer / Desktopプレビュー）</title>
  <!-- 説明:
    - iOS: Quick Look (USDZ)
    - Android: Scene Viewer (GLB/GLTF)
    - Desktop: 3Dプレビュー + QRコードでスマホへ
    - 可能なら <model-viewer> による3Dプレビュー/AR起動
  -->

  <!-- 3Dプレビュー用（Google model-viewer）
       公式: https://modelviewer.dev/  -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>

  <!-- Desktop→スマホ遷移用のQRコード（軽量ライブラリ） -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- 事前読み込み（任意） -->
  <!-- 事前読み込み（任意）: デフォルトの公開デモモデルをpreload -->
  <link rel="preload" href="./model.usdz" as="fetch" crossorigin>
  <link rel="preload" href="https://modelviewer.dev/shared-assets/models/Astronaut.glb" as="fetch" crossorigin>

  <style>
    :root {
      --bg: #0b0f1a;
      --card: #111827;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, #0f172a 0%, var(--bg) 60%);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }
    .wrap { width: 100%; max-width: 980px; }
    header { text-align: center; margin-bottom: 16px; }
    h1 { font-size: clamp(22px, 4vw, 32px); margin: 0 0 8px; }
    p.lead { color: var(--muted); margin: 0; }

    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 960px) {
      .grid { grid-template-columns: 2fr 1fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow: hidden;
    }

    model-viewer {
      width: 100%;
      height: 56vh;
      min-height: 360px;
      background: #0a0e1a;
    }

    .panel { padding: 16px; }
    .buttons { display: flex; flex-wrap: wrap; gap: 12px; }
    .button, a.button {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; text-decoration: none;
      padding: 12px 16px; border-radius: 12px; font-weight: 600;
      background: var(--accent); color: white; border: none; cursor: pointer;
      transition: transform .06s ease, filter .15s ease;
    }
    .button.secondary { background: #334155; }
    .button.ghost { background: transparent; border: 1px solid #334155; }
    .button:hover { filter: brightness(1.08); }
    .button:active { transform: translateY(1px); }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }

    .qr-wrap { display: none; align-items: center; gap: 12px; }
    .qr-box {
      width: 140px; height: 140px; padding: 8px; border-radius: 12px;
      background: white; display: grid; place-items: center;
    }

    footer { margin-top: 18px; text-align: center; color: var(--muted); font-size: 12px; }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; }
      /* レティクル（円グリッド風） */
    #reticle {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08) inset, 0 0 30px rgba(0,0,0,0.35);
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.25) 0 2px, transparent 2px 100%),
        repeating-conic-gradient(from 0deg, rgba(255,255,255,0.08) 0 10deg, transparent 10deg 20deg);
      display: none;
      pointer-events: none;
      transform: translate(-50%, -50%);
      position: absolute; top: 50%; left: 50%;
    }
    model-viewer[ar-status="session-started"] #reticle { display: block; }
      /* サムネイル&コントロール */
    .thumbs { display: flex; flex-wrap: wrap; gap: 10px; }
    .thumb { width: 88px; height: 88px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); background: #0b1220; cursor: pointer; display:grid; place-items:center; }
    .thumb img { max-width: 100%; max-height: 100%; opacity: .9; }
    .thumb.active { outline: 2px solid var(--accent); }
    .controls { display: grid; gap: 8px; }
    .controls label { display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 14px; color: var(--muted); }
    .controls input[type="range"] { width: 180px; }
    .controls .row { gap: 6px; }

    /* コンフェッティ */
    .confetti { position: fixed; top: -10px; width: 8px; height: 14px; opacity: 0.9; transform: rotate(0deg); will-change: transform, top, opacity; }
    .confetti.anim { animation: fall 900ms ease-out forwards; }
    @keyframes fall { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(110vh) rotate(540deg); opacity: 0; } }

      /* レティクル（円グリッド風） */
    #reticle {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08) inset, 0 0 30px rgba(0,0,0,0.35);
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.25) 0 2px, transparent 2px 100%),
        repeating-conic-gradient(from 0deg, rgba(255,255,255,0.08) 0 10deg, transparent 10deg 20deg);
      display: none;
      pointer-events: none;
      transform: translate(-50%, -50%);
      position: absolute; top: 50%; left: 50%;
    }
    model-viewer[ar-status="session-started"] #reticle { display: block; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARで見る</h1>
      <p class="lead">iOS / Android / Desktop どれでもOK。まずはプレビュー、端末に応じて最適なARを起動します。</p>
    </header>

    <div class="grid">
      <!-- 左: 3Dプレビュー -->
      <div class="card">
        <!--
          src: Android/デスクトップ用（glb/gltf）
          ios-src: iOS Quick Look用（usdz）
          ar-modes: 可能なAR起動手段を列挙
        -->
        <model-viewer id="viewer"$1environment-image="https://modelviewer.dev/shared-assets/environments/spruit_sunrise_1k_HDR.hdr" alt="3Dモデルのプレビュー">

          <!-- model-viewer 内のARボタン（フォールバック） -->
          <button slot="ar-button" class="button">📱 ARで表示</button>
          <div class="hint" slot="poster">読み込み中…</div>

          <!-- 置き場所の簡易レティクル（WebXR時に表示） -->
          <div id="reticle" slot="ar" aria-hidden="true"></div>
        </model-viewer>
      </div>

      <!-- 右: 操作パネル -->
      <div class="card panel">
        <h2 style="margin-top:0">端末に合わせてAR起動</h2>
        <div class="buttons" style="margin-bottom:8px">
          <!-- iOS Quick Look: a[rel=ar] が最短 -->
          <a id="btn-ios" class="button" rel="ar" href="#" title="iPhone / iPad 用">
             iPhone / iPad でAR
          </a>

          <!-- Android Scene Viewer: intent URLを生成 -->
          <a id="btn-android" class="button secondary" href="#" title="Android 用">
            🤖 AndroidでAR
          </a>

          <!-- デスクトップ: QRコード or 共有リンク -->
          <button id="btn-desktop" class="button ghost" title="デスクトップ向け">
            🖥️ デスクトップ→スマホ
          </button>
        </div>

        <!-- 楽しむ：モデル切替 & 見栄え調整 -->
        <div style="margin:10px 0 6px; font-weight:700">モデルを選ぶ</div>
        <div id="presets" class="thumbs"></div>

        <div style="margin:12px 0 6px; font-weight:700">ライティング</div>
        <div class="controls">
          <label>露出 <input id="ctrl-exposure" type="range" min="0.2" max="2.0" step="0.05" value="1.0"></label>
          <label>影の濃さ <input id="ctrl-shadow" type="range" min="0" max="2" step="0.05" value="1"></label>
          <label class="row"><input id="ctrl-autorotate" type="checkbox" checked> 自動回転</label>
        </div>

        <div id="qr" class="qr-wrap">
          <div class="qr-box"><div id="qrcode"></div></div>
          <div>
            <div>スマホのカメラでQRを読み取って、このページを開いてください。</div>
            <div class="hint">同じWi‑Fiでない場合は、ホスティングURLが外部から到達可能である必要があります。</div>
          </div>
        </div>

        <hr style="border-color: rgba(255,255,255,0.06); margin:16px 0;">
        <details>
          <summary>セットアップメモ</summary>
          <ul style="margin:8px 0 0 16px; color: var(--muted); font-size: 14px;">
            <li><code>./model.usdz</code>（iOS向け）と<code>./model.glb</code>（Android/プレビュー向け）を同じディレクトリに配置。</li>
            <li>AndroidのScene ViewerはHTTPSかつ公開URL推奨。ローカルの場合はUSBデバッグから開発者オプション等で検証。</li>
            <li>Quick Lookの挙動（固定スケール等）はUSDZ側の設定に依存します。</li>
          </ul>
        </details>
      </div>
    </div>

    <footer>
      <span>AR起動がうまくいかない時は、端末のOS/ブラウザの最新版をお試しください。</span>
    </footer>
  </div>

  <script>
    // --- ユーティリティ: 端末判定 ---
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(ua);

    // --- 要素参照 ---
    const btnIOS = document.getElementById('btn-ios');
    const btnAndroid = document.getElementById('btn-android');
    const btnDesktop = document.getElementById('btn-desktop');
    const qrWrap = document.getElementById('qr');

    // --- Android Scene Viewer intent URLを構築 ---
    function buildSceneViewerUrl(params) {
      const base = 'https://arvr.google.com/scene-viewer/1.0';
      const url = new URL(base);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      return url.toString();
    }

    // ここは公開URLに差し替えてください（同一オリジン推奨）
    // クエリパラメータでモデル差し替え可能: ?glb=...&usdz=...
    const params = new URLSearchParams(location.search);
    const defaultGLB = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
    const localUSDZ = new URL('./model.usdz', location.href).toString();
    const fallbackUSDZDemo = 'https://modelviewer.dev/shared-assets/models/Astronaut.usdz';
    const glbUrl = params.get('glb') || defaultGLB;
    // iPhone/iPadではまずローカル model.usdz を使う（指定があれば ?usdz=... を優先）
    let usdzUrl = params.get('usdz') || localUSDZ;

    // model-viewerへ反映
    const viewer = document.getElementById('viewer');
    viewer.setAttribute('src', glbUrl);
    viewer.setAttribute('ios-src', usdzUrl);

    // Androidボタンのhrefを設定
    const sceneViewerURL = buildSceneViewerUrl({
      file: glbUrl,
      mode: 'ar_only',
      title: document.title || 'WebAR Model',
      // link パラメータで戻り先（任意）
      link: location.href
    });
    btnAndroid.href = sceneViewerURL;
    // iOSボタンのhrefも動的に反映
    btnIOS.href = usdzUrl;

    // --- 端末別にデフォルトボタンを強調表示 ---
    if (isIOS) {
      btnIOS.classList.remove('secondary', 'ghost');
    } else if (isAndroid) {
      btnAndroid.classList.remove('secondary');
      btnAndroid.classList.add('button');
    } else {
      btnDesktop.classList.remove('ghost');
      btnDesktop.classList.add('button');
    }

    // --- Desktop: QRコード表示/非表示 ---
    let qrRendered = false;
    btnDesktop?.addEventListener('click', () => {
      qrWrap.style.display = qrWrap.style.display === 'flex' ? 'none' : 'flex';
      if (!qrRendered) {
        // 現在のページURLをQR化
        // 外部からアクセスできるURLでホストしてください
        new QRCode(document.getElementById('qrcode'), {
          text: location.href,
          width: 120,
          height: 120,
          correctLevel: QRCode.CorrectLevel.M
        });
        qrRendered = true;
      }
    });

    // --- Web Share API（対応ブラウザのみ）---
    if (navigator.share) {
      const shareBtn = document.createElement('button');
      shareBtn.textContent = '📤 共有';
      shareBtn.className = 'button ghost';
      shareBtn.style.marginLeft = '8px';
      shareBtn.addEventListener('click', async () => {
        try {
          await navigator.share({ title: document.title, url: location.href });
        } catch (e) { /* キャンセルなど */ }
      });
      document.querySelector('.buttons').appendChild(shareBtn);
    }

    // --- ちょい上級: iOSでの即時Quick Look起動（任意） ---
    // ページ表示と同時に起動したい場合などは以下を活用（UXに注意）
    // if (isIOS) {
    //   const a = document.createElement('a');
    //   a.setAttribute('rel', 'ar');
    //   a.setAttribute('href', './model.usdz');
    //   a.style.display = 'none';
    //   document.body.appendChild(a);
    //   a.click();
    //   a.remove();
    // }
      // --- 404対策: モデルURLの妥当性を軽量チェック（HEADが使えない環境はGETでフォールバック） ---
    async function assertReachable(url) {
      try {
        const res = await fetch(url, { method: 'HEAD', mode: 'cors' });
        if (!res.ok) throw new Error(String(res.status));
        return true;
      } catch (e) {
        console.warn('モデルにアクセスできませんでした:', url, e);
        return false;
      }
    }

    (async () => {
      const okGLB = await assertReachable(glbUrl);
      let okUSDZ = await assertReachable(usdzUrl);

      // iOS優先: ローカルUSDZが無い場合はデモに自動フォールバック
      if (isIOS && !okUSDZ) {
        console.warn('local USDZ not found. Falling back to demo USDZ.');
        usdzUrl = fallbackUSDZDemo;
        viewer.setAttribute('ios-src', usdzUrl);
        btnIOS.href = usdzUrl;
        okUSDZ = await assertReachable(usdzUrl);
      }

      const warn = [];
      if (!okGLB) warn.push('GLB');
      if (!okUSDZ) warn.push('USDZ');
      if (warn.length) {
        const el = document.createElement('div');
        el.role = 'status';
        el.style.cssText = 'margin-top:8px;color:#fca5a5;font-size:12px;';
        el.textContent = `${warn.join(' / ')} の取得に失敗しました。URLまたはホスティングの設定（MIME type含む）を確認してください。`;
        document.querySelector('.panel').appendChild(el);
      }
    })();

    // --- WebXR簡易「スポット置き」 + 演出 ---
    const reticle = document.getElementById('reticle');

    function haptic() { if (navigator.vibrate) navigator.vibrate(15); }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'triangle'; o.frequency.value = 660; g.gain.value = 0.05;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 120);
      } catch (e) {}
    }

    function spawnConfetti(n=24) {
      for (let i=0;i<n;i++) {
        const el = document.createElement('div');
        el.className = 'confetti anim';
        const hue = Math.floor(Math.random()*360);
        el.style.background = `hsl(${hue} 90% 60%)`;
        el.style.left = (Math.random()*100)+'vw';
        el.style.animationDelay = (Math.random()*0.2)+'s';
        el.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 1000);
      }
    }

    function popReticle() {
      if (!reticle || viewer.getAttribute('ar-status') !== 'session-started') return;
      reticle.animate([
        { transform: 'translate(-50%, -50%) scale(0.6)', opacity: 0.0 },
        { transform: 'translate(-50%, -50%) scale(1.0)', opacity: 1.0, offset: 0.5 },
        { transform: 'translate(-50%, -50%) scale(1.0)', opacity: 0.0 }
      ], { duration: 420, easing: 'ease-out' });
      haptic();
      playBeep();
      spawnConfetti(18);
    }

    viewer.addEventListener('click', () => popReticle());

    // --- モデルプリセット（プレビュー/Android向けGLB。iOSはローカルUSDZを優先） ---
    const presets = [
      { name:'Astronaut', glb:'https://modelviewer.dev/shared-assets/models/Astronaut.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/Astronaut.webp' },
      { name:'Robot', glb:'https://modelviewer.dev/shared-assets/models/RobotExpressive.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/RobotExpressive.webp' },
      { name:'Horse', glb:'https://modelviewer.dev/shared-assets/models/Horse.glb', thumb:'https://modelviewer.dev/shared-assets/thumbnails/Horse.webp' }
    ];

    const $presets = document.getElementById('presets');
    const presetEls = presets.map((p, idx) => {
      const b = document.createElement('button');
      b.className = 'thumb'+(idx===0?' active':'');
      b.title = p.name;
      const img = document.createElement('img'); img.src = p.thumb; img.alt = p.name; b.appendChild(img);
      b.addEventListener('click', () => {
        presetEls.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        viewer.setAttribute('src', p.glb);
        // AndroidのScene Viewerも更新
        const updated = buildSceneViewerUrl({ file: p.glb, mode:'ar_only', title: document.title || p.name, link: location.href });
        btnAndroid.href = updated;
      });
      $presets.appendChild(b); return b;
    });

    // --- 露出/影/回転コントロール ---
    const ctrlExposure = document.getElementById('ctrl-exposure');
    const ctrlShadow = document.getElementById('ctrl-shadow');
    const ctrlAuto = document.getElementById('ctrl-autorotate');
    ctrlExposure.addEventListener('input', () => viewer.setAttribute('exposure', ctrlExposure.value));
    ctrlShadow.addEventListener('input', () => viewer.setAttribute('shadow-intensity', ctrlShadow.value));
    ctrlAuto.addEventListener('change', () => ctrlAuto.checked ? viewer.setAttribute('auto-rotate','') : viewer.removeAttribute('auto-rotate'));

    // 補足: 本当に平面に沿ってレティクル(メッシュ)を表示し、タップで確定配置したい場合は
    // three.js + WebXR Hit Test API での実装に切り替える必要があります。
  </script>
</body>
</html>
